<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vLLM Batch Processing Dashboard</title>
    <link rel="stylesheet" href="static/css/shared.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .status-card {
            background: var(--surface-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .status-card h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background: #3fb950; }
        .status-degraded { background: #d29922; }
        .status-dead { background: #f85149; }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .metric-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .job-list {
            margin-top: var(--spacing-lg);
        }

        .job-item {
            background: var(--surface-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .job-id {
            font-family: monospace;
            font-size: 13px;
            color: var(--text-primary);
        }

        .job-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending { background: #388bfd20; color: #58a6ff; }
        .status-running { background: #3fb95020; color: #3fb950; }
        .status-completed { background: #3fb95020; color: #3fb950; }
        .status-failed { background: #f8514920; color: #f85149; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--spacing-sm) 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #3fb950);
            transition: width 0.3s ease;
        }

        .job-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-sm);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        .btn-secondary {
            background: var(--surface-white);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--border-hover);
        }

        .refresh-indicator {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: right;
            margin-bottom: var(--spacing-sm);
        }

        .error-banner {
            background: #f8514920;
            border: 1px solid #f85149;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            color: #f85149;
        }

        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--text-primary);
            border-bottom-color: #58a6ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ vLLM Batch Processing Dashboard</h1>
        <p class="subtitle">Real-time monitoring and job management</p>

        <div class="refresh-indicator" id="lastUpdate">Last updated: Never</div>

        <div id="errorBanner" style="display: none;" class="error-banner"></div>

        <!-- System Status Cards -->
        <div class="dashboard-grid">
            <!-- GPU Status -->
            <div class="status-card">
                <h3>üéÆ GPU Status</h3>
                <div id="gpuStatus">Loading...</div>
            </div>

            <!-- Worker Status -->
            <div class="status-card">
                <h3>‚öôÔ∏è Worker Status</h3>
                <div id="workerStatus">Loading...</div>
            </div>

            <!-- Queue Status -->
            <div class="status-card">
                <h3>üìã Queue Status</h3>
                <div id="queueStatus">Loading...</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('active')">Active Jobs</button>
            <button class="tab" onclick="switchTab('completed')">Completed</button>
            <button class="tab" onclick="switchTab('failed')">Failed</button>
            <button class="tab" onclick="switchTab('results')">View Results</button>
        </div>

        <!-- Tab Content -->
        <div id="activeTab" class="tab-content active">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="window.location.href='submit_batch.html'">
                    ‚ûï Submit New Batch
                </button>
                <button class="btn btn-secondary" onclick="refreshData()">
                    üîÑ Refresh
                </button>
            </div>
            <div id="activeJobs" class="job-list"></div>
        </div>

        <div id="completedTab" class="tab-content">
            <div id="completedJobs" class="job-list"></div>
        </div>

        <div id="failedTab" class="tab-content">
            <div id="failedJobs" class="job-list"></div>
        </div>

        <div id="resultsTab" class="tab-content">
            <p>Redirecting to results viewer...</p>
            <script>
                // Auto-redirect when results tab is clicked
                document.querySelector('.tab:nth-child(4)').addEventListener('click', () => {
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 500);
                });
            </script>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4080';
        let currentTab = 'active';

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}Tab`).classList.add('active');
        }

        async function refreshData() {
            try {
                // Fetch health status
                const healthRes = await fetch(`${API_BASE}/health`);
                if (!healthRes.ok) throw new Error('API server not responding');
                
                const health = await healthRes.json();
                updateSystemStatus(health);

                // Fetch all batches
                const batchesRes = await fetch(`${API_BASE}/v1/batches`);
                const batches = await batchesRes.json();
                updateJobLists(batches.batches || []);

                // Update timestamp
                document.getElementById('lastUpdate').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
                
                // Hide error banner
                document.getElementById('errorBanner').style.display = 'none';
            } catch (error) {
                showError(`Failed to connect to API server: ${error.message}. Make sure the API server is running on port 8080.`);
            }
        }

        function updateSystemStatus(health) {
            // GPU Status
            const gpuHtml = `
                <div class="metric-row">
                    <span class="metric-label">Status</span>
                    <span class="metric-value">
                        <span class="status-indicator status-${health.gpu.healthy ? 'healthy' : 'degraded'}"></span>
                        ${health.gpu.healthy ? 'Healthy' : 'Degraded'}
                    </span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Memory</span>
                    <span class="metric-value">${health.gpu.memory_percent.toFixed(1)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Temperature</span>
                    <span class="metric-value">${health.gpu.temperature_c}¬∞C</span>
                </div>
            `;
            document.getElementById('gpuStatus').innerHTML = gpuHtml;

            // Worker Status
            const worker = health.worker;
            const workerHealthy = worker.status !== 'unknown' && worker.age_seconds < 60;
            const workerHtml = `
                <div class="metric-row">
                    <span class="metric-label">Status</span>
                    <span class="metric-value">
                        <span class="status-indicator status-${workerHealthy ? 'healthy' : 'dead'}"></span>
                        ${worker.status || 'Unknown'}
                    </span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Current Job</span>
                    <span class="metric-value">${worker.current_job_id || 'None'}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Last Seen</span>
                    <span class="metric-value">${worker.age_seconds ? `${Math.round(worker.age_seconds)}s ago` : 'Never'}</span>
                </div>
            `;
            document.getElementById('workerStatus').innerHTML = workerHtml;

            // Queue Status
            const queueHtml = `
                <div class="metric-row">
                    <span class="metric-label">Active Jobs</span>
                    <span class="metric-value">${health.queue.active_jobs} / ${health.queue.max_queue_depth}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Queued Requests</span>
                    <span class="metric-value">${health.queue.total_queued_requests.toLocaleString()} / ${health.queue.max_queued_requests.toLocaleString()}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Available Slots</span>
                    <span class="metric-value">${health.queue.queue_available}</span>
                </div>
            `;
            document.getElementById('queueStatus').innerHTML = queueHtml;
        }

        function updateJobLists(batches) {
            const active = batches.filter(b => ['pending', 'running'].includes(b.status));
            const completed = batches.filter(b => b.status === 'completed');
            const failed = batches.filter(b => b.status === 'failed');

            document.getElementById('activeJobs').innerHTML = active.length > 0 
                ? active.map(renderJob).join('') 
                : '<p style="color: var(--text-secondary);">No active jobs</p>';
            
            document.getElementById('completedJobs').innerHTML = completed.length > 0 
                ? completed.map(renderJob).join('') 
                : '<p style="color: var(--text-secondary);">No completed jobs</p>';
            
            document.getElementById('failedJobs').innerHTML = failed.length > 0 
                ? failed.map(renderJob).join('') 
                : '<p style="color: var(--text-secondary);">No failed jobs</p>';
        }

        function renderJob(job) {
            const progress = job.progress;
            const percent = progress.percent || 0;
            
            return `
                <div class="job-item">
                    <div class="job-header">
                        <span class="job-id">${job.batch_id}</span>
                        <span class="job-status status-${job.status}">${job.status.toUpperCase()}</span>
                    </div>
                    
                    ${job.status === 'running' ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%"></div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                            ${progress.completed.toLocaleString()} / ${progress.total.toLocaleString()} (${percent}%)
                        </div>
                    ` : ''}
                    
                    <div class="job-meta">
                        <div><strong>Model:</strong> ${job.model}</div>
                        <div><strong>Requests:</strong> ${progress.total.toLocaleString()}</div>
                        ${job.throughput_tokens_per_sec ? `<div><strong>Throughput:</strong> ${Math.round(job.throughput_tokens_per_sec)} tok/s</div>` : ''}
                        ${job.error_message ? `<div style="color: #f85149;"><strong>Error:</strong> ${job.error_message}</div>` : ''}
                    </div>
                    
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        ${job.status === 'completed' ? `
                            <button class="btn btn-primary" onclick="downloadResults('${job.batch_id}')">
                                üì• Download Results
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="viewLogs('${job.batch_id}')">
                            üìÑ View Logs
                        </button>
                        ${job.status === 'pending' ? `
                            <button class="btn btn-secondary" onclick="cancelJob('${job.batch_id}')">
                                ‚ùå Cancel
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        async function downloadResults(batchId) {
            window.open(`${API_BASE}/v1/batches/${batchId}/results`, '_blank');
        }

        async function viewLogs(batchId) {
            const res = await fetch(`${API_BASE}/v1/batches/${batchId}/logs`);
            const data = await res.json();
            alert(data.logs);
        }

        async function cancelJob(batchId) {
            if (!confirm(`Cancel batch ${batchId}?`)) return;
            
            await fetch(`${API_BASE}/v1/batches/${batchId}`, { method: 'DELETE' });
            refreshData();
        }

        function showError(message) {
            const banner = document.getElementById('errorBanner');
            banner.textContent = message;
            banner.style.display = 'block';
        }

        // Auto-refresh every 5 seconds
        refreshData();
        setInterval(refreshData, 5000);
    </script>
</body>
</html>

