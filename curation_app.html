<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold-Star Curation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #2c3e50;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #6a737d;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .help-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .help-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-select {
            padding: 8px 16px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            background: white;
            color: #2c3e50;
            cursor: pointer;
        }

        .search-input {
            padding: 8px 16px;
            border: 2px solid #e1e4e8;
            border-radius: 6px;
            font-size: 14px;
            width: 250px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Main Card Container */
        .card-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 0;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow-y: auto;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 40px;
            transition: opacity 0.2s ease;
        }

        .card-section {
            min-width: 0;
        }

        .card h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e4e8;
        }

        /* Candidate Card */
        .candidate-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e4e8;
        }

        .candidate-name {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 6px;
        }

        .candidate-role {
            font-size: 15px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .candidate-location {
            font-size: 13px;
            color: #6a737d;
        }

        /* LinkedIn-style Profile */
        .linkedin-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e1e4e8;
        }

        .linkedin-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 16px;
        }

        .linkedin-item {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .linkedin-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .linkedin-icon {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            background: #f6f8fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .linkedin-content {
            flex: 1;
            min-width: 0;
        }

        .linkedin-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .linkedin-subtitle {
            font-size: 13px;
            color: #586069;
            margin-bottom: 4px;
        }

        .linkedin-meta {
            font-size: 12px;
            color: #8b949e;
        }

        .linkedin-description {
            font-size: 13px;
            color: #2c3e50;
            line-height: 1.6;
            margin-top: 8px;
        }

        /* Evaluation Card */
        .eval-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .edit-btn, .save-btn, .cancel-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-btn {
            background: #667eea;
            color: white;
        }

        .edit-btn:hover {
            background: #5568d3;
        }

        .save-btn {
            background: #28a745;
            color: white;
            margin-right: 8px;
        }

        .save-btn:hover {
            background: #218838;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .cancel-btn:hover {
            background: #5a6268;
        }

        .recommendation {
            margin-bottom: 20px;
        }

        .recommendation-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .badge-strong-yes { background: #d4edda; color: #155724; }
        .badge-yes { background: #d1ecf1; color: #0c5460; }
        .badge-maybe { background: #fff3cd; color: #856404; }
        .badge-no { background: #f8d7da; color: #721c24; }
        .badge-strong-no { background: #f5c6cb; color: #721c24; }

        .reasoning {
            background: #f6f8fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 14px;
        }

        .analysis-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e4e8;
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-item h4 {
            font-size: 14px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .rating-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .rating-great { background: #d4edda; color: #155724; }
        .rating-good { background: #d1ecf1; color: #0c5460; }
        .rating-average { background: #fff3cd; color: #856404; }
        .rating-weak { background: #f8d7da; color: #721c24; }
        .rating-none { background: #e2e3e5; color: #383d41; }

        .analysis-reasoning {
            font-size: 13px;
            color: #6a737d;
            line-height: 1.5;
        }

        /* Edit Mode Styles */
        .editable-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            background: white;
            cursor: pointer;
        }

        .editable-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .editable-rating-select {
            padding: 4px 10px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            background: white;
            cursor: pointer;
        }

        .edit-indicator {
            display: inline-block;
            background: #ffc107;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 10px;
        }

        /* Actions Bar */
        .actions-bar {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .rating-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .rating-btn {
            width: 50px;
            height: 50px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rating-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-skip {
            background: #6c757d;
            color: white;
        }

        .btn-skip:hover {
            background: #5a6268;
        }

        .btn-prev {
            background: #e1e4e8;
            color: #2c3e50;
        }

        .btn-prev:hover {
            background: #d1d5da;
        }

        .btn-next {
            background: #667eea;
            color: white;
        }

        .btn-next:hover {
            background: #5568d3;
        }

        /* Progress Bar */
        .progress-container {
            background: white;
            border-radius: 12px;
            padding: 15px 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .progress-bar-bg {
            background: #e1e4e8;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #6a737d;
        }

        .progress-text strong {
            color: #2c3e50;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 18px;
            color: #6a737d;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Help Overlay */
        .help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .help-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .help-content h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .help-section {
            margin-bottom: 25px;
        }

        .help-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .help-shortcuts {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            font-size: 14px;
        }

        .help-key {
            background: #f6f8fa;
            padding: 6px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: 600;
            text-align: center;
        }

        .help-desc {
            padding: 6px 0;
            color: #6a737d;
        }

        .close-help-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .close-help-btn:hover {
            background: #5568d3;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 1.7s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>‚≠ê Gold-Star Curation</h1>

            <div class="filter-controls">
                <select class="filter-select" id="filter-select" onchange="applyFilter()">
                    <option value="all">All Candidates</option>
                    <option value="unreviewed">Unreviewed Only</option>
                    <option value="starred">Starred Only</option>
                    <option value="skipped">Skipped Only</option>
                </select>
                <input type="text" class="search-input" id="search-input" placeholder="Search by name..." oninput="applyFilter()">
            </div>

            <div class="stats">
                <div class="stat">
                    <span class="stat-value" id="reviewed-count">0</span>
                    <span>/ <span id="total-count">0</span> reviewed</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="starred-count">0</span>
                    <span>starred</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="skipped-count">0</span>
                    <span>skipped</span>
                </div>
            </div>
            <button class="help-btn" id="help-btn">?</button>
        </div>

        <!-- Main Card Container -->
        <div class="card-container">
            <!-- Single Card with Horizontal Layout -->
            <div class="card">
                <!-- Left: Candidate Profile -->
                <div class="card-section">
                    <h2>üë§ Candidate</h2>
                    <div id="candidate-content" class="loading">Loading...</div>
                </div>

                <!-- Right: LLM Evaluation -->
                <div class="card-section">
                    <div class="eval-header">
                        <h2>ü§ñ LLM Evaluation</h2>
                        <div id="edit-controls">
                            <button class="edit-btn" id="edit-btn" onclick="toggleEditMode()">Edit</button>
                            <button class="save-btn hidden" id="save-btn" onclick="saveEdits()">Save</button>
                            <button class="cancel-btn hidden" id="cancel-btn" onclick="cancelEdits()">Cancel</button>
                        </div>
                    </div>
                    <div id="evaluation-content" class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="actions-bar">
            <div class="rating-buttons">
                <button class="rating-btn" onclick="rateCandidate(1)">1</button>
                <button class="rating-btn" onclick="rateCandidate(2)">2</button>
                <button class="rating-btn" onclick="rateCandidate(3)">3</button>
                <button class="rating-btn" onclick="rateCandidate(4)">4</button>
                <button class="rating-btn" onclick="rateCandidate(5)">5</button>
                <button class="rating-btn" onclick="rateCandidate(6)">6</button>
                <button class="rating-btn" onclick="rateCandidate(7)">7</button>
                <button class="rating-btn" onclick="rateCandidate(8)">8</button>
                <button class="rating-btn" onclick="rateCandidate(9)">9</button>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn btn-skip" onclick="skipCandidate()">Skip (s)</button>
                <button class="nav-btn btn-prev" onclick="prevCandidate()">‚Üê Prev (p)</button>
                <button class="nav-btn btn-next" onclick="nextCandidate()">Next (n) ‚Üí</button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-text">
                <strong id="current-index">0</strong> of <strong id="total-candidates">0</strong>
                (<span id="progress-percent">0</span>%)
            </div>
        </div>
    </div>

    <!-- Help Overlay -->
    <div class="help-overlay hidden" id="help-overlay">
        <div class="help-content" id="help-content">
            <h2>‚å®Ô∏è Keyboard Shortcuts</h2>

            <div class="help-section">
                <h3>Rating</h3>
                <div class="help-shortcuts">
                    <div class="help-key">1-9</div>
                    <div class="help-desc">Rate candidate and star (auto-advance)</div>
                </div>
            </div>

            <div class="help-section">
                <h3>Navigation</h3>
                <div class="help-shortcuts">
                    <div class="help-key">n or ‚Üí</div>
                    <div class="help-desc">Next candidate</div>
                    <div class="help-key">p or ‚Üê</div>
                    <div class="help-desc">Previous candidate</div>
                    <div class="help-key">s</div>
                    <div class="help-desc">Skip candidate (not good enough)</div>
                </div>
            </div>

            <div class="help-section">
                <h3>Editing</h3>
                <div class="help-shortcuts">
                    <div class="help-key">e</div>
                    <div class="help-desc">Enter edit mode</div>
                    <div class="help-key">ESC</div>
                    <div class="help-desc">Cancel edits</div>
                </div>
            </div>

            <div class="help-section">
                <h3>Other</h3>
                <div class="help-shortcuts">
                    <div class="help-key">?</div>
                    <div class="help-desc">Show this help</div>
                </div>
            </div>

            <button class="close-help-btn" id="close-help-btn">Close</button>
        </div>
    </div>

    <script>
        // State
        const state = {
            candidates: [],
            results: {},
            currentIndex: 0,
            filteredIndices: [],
            currentFilteredIndex: 0,
            reviewed: new Set(),
            starred: new Map(),
            skipped: new Set(),
            isEditing: false,
            originalData: null,
            editedData: null,
            filter: 'all',
            searchQuery: ''
        };

        // Load data on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Ensure help overlay is hidden on load
            const helpOverlay = document.getElementById('help-overlay');
            if (helpOverlay) {
                helpOverlay.classList.add('hidden');
            }

            await loadData();
            applyFilter();
            renderCurrentCandidate();
            setupKeyboardShortcuts();

            // Setup help button
            const helpBtn = document.getElementById('help-btn');
            if (helpBtn) {
                helpBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.showHelp();
                });
            }

            // Setup help overlay close button
            const closeBtn = document.getElementById('close-help-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.hideHelp();
                });
            }

            // Setup help overlay click-outside-to-close
            const helpContent = document.getElementById('help-content');
            if (helpOverlay && helpContent) {
                helpOverlay.addEventListener('click', (e) => {
                    if (e.target === helpOverlay) {
                        window.hideHelp();
                    }
                });
                helpContent.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        });

        // Load batch file and results
        async function loadData() {
            try {
                // Load batch file (candidates)
                const batchResponse = await fetch('/batch_5k.jsonl');
                const batchText = await batchResponse.text();
                state.candidates = batchText.trim().split('\n').map(line => JSON.parse(line));

                // Load results file
                const resultsResponse = await fetch('/llama32_3b_5k_results.jsonl');
                const resultsText = await resultsResponse.text();
                const results = resultsText.trim().split('\n').map(line => JSON.parse(line));

                // Index results by custom_id
                results.forEach(result => {
                    state.results[result.custom_id] = result;
                });

                updateStats();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. Make sure batch_5k.jsonl and llama32_3b_5k_results.jsonl exist.');
            }
        }

        // Apply filter
        function applyFilter() {
            const filterValue = document.getElementById('filter-select')?.value || 'all';
            const searchQuery = document.getElementById('search-input')?.value.toLowerCase() || '';

            state.filter = filterValue;
            state.searchQuery = searchQuery;

            // Build filtered indices
            state.filteredIndices = [];

            for (let i = 0; i < state.candidates.length; i++) {
                const candidate = state.candidates[i];
                const customId = candidate.custom_id;

                // Apply filter
                let passesFilter = true;

                if (filterValue === 'unreviewed') {
                    passesFilter = !state.reviewed.has(customId);
                } else if (filterValue === 'starred') {
                    passesFilter = state.starred.has(customId);
                } else if (filterValue === 'skipped') {
                    passesFilter = state.skipped.has(customId);
                }

                // Apply search
                if (passesFilter && searchQuery) {
                    const candidateName = extractCandidateName(candidate).toLowerCase();
                    passesFilter = candidateName.includes(searchQuery);
                }

                if (passesFilter) {
                    state.filteredIndices.push(i);
                }
            }

            // Reset to first filtered candidate
            state.currentFilteredIndex = 0;
            if (state.filteredIndices.length > 0) {
                state.currentIndex = state.filteredIndices[0];
            }

            updateStats();
            renderCurrentCandidate();
        }

        // Render current candidate
        function renderCurrentCandidate() {
            if (state.filteredIndices.length === 0) {
                document.getElementById('candidate-content').innerHTML = '<div class="loading">No candidates match filter</div>';
                document.getElementById('evaluation-content').innerHTML = '<div class="loading">No candidates match filter</div>';
                updateProgress();
                return;
            }

            const candidate = state.candidates[state.currentIndex];
            if (!candidate) return;

            // Reset edit mode UI
            document.getElementById('edit-btn').classList.remove('hidden');
            document.getElementById('save-btn').classList.add('hidden');
            document.getElementById('cancel-btn').classList.add('hidden');

            renderCandidateCard(candidate);
            renderEvaluationCard(candidate);
            updateProgress();
        }

        // Extract structured candidate data
        function extractCandidateData(candidate) {
            const messages = candidate.body?.messages || [];
            const userMsg = messages.find(m => m.role === 'user');
            if (!userMsg) return null;

            const content = userMsg.content;

            // Extract basic info
            const nameMatch = content.match(/\*\*Candidate:\*\*\s*([^\n]+)/);
            const roleMatch = content.match(/\*\*Current Role:\*\*\s*([^\n]+)/);
            const locationMatch = content.match(/\*\*Location:\*\*\s*([^\n]+)/);
            const workHistoryMatch = content.match(/\*\*Work History:\*\*\s*([\s\S]*?)(?=\n\*\*|$)/);
            const educationMatch = content.match(/\*\*Education:\*\*\s*([\s\S]*?)(?=\n\*\*|$)/);

            const name = nameMatch ? nameMatch[1].trim() : 'Unknown';
            const role = roleMatch ? roleMatch[1].trim() : 'Not specified';
            const location = locationMatch ? locationMatch[1].trim() : 'Not specified';

            // Parse work history
            let workHistory = [];
            if (workHistoryMatch) {
                const workText = workHistoryMatch[1].trim();
                if (!workText.includes('No work history')) {
                    workHistory = workText.split('\n')
                        .filter(line => line.trim().startsWith('‚Ä¢'))
                        .map(line => {
                            const text = line.trim().substring(1).trim();
                            // Parse: "Title at Company (start - end)"
                            const match = text.match(/^(.+?)\s+at\s+(.+?)\s+\((.+?)\s+-\s+(.+?)\)$/);
                            if (match) {
                                return {
                                    title: match[1].trim(),
                                    company: match[2].trim(),
                                    startDate: match[3].trim(),
                                    endDate: match[4].trim() === '1970-01-01' ? 'Present' : match[4].trim()
                                };
                            }
                            return null;
                        })
                        .filter(job => job !== null);
                }
            }

            // Parse education
            let education = [];
            if (educationMatch) {
                const eduText = educationMatch[1].trim();
                if (!eduText.includes('No education')) {
                    education = eduText.split('\n')
                        .filter(line => line.trim().startsWith('‚Ä¢'))
                        .map(line => {
                            const text = line.trim().substring(1).trim();
                            // Parse: "Bachelor of Science - BS in Computer Science from MIT"
                            const fromMatch = text.match(/\s+from\s+(.+)$/);
                            const school = fromMatch ? fromMatch[1].trim() : '';

                            // Get degree part (everything before "from")
                            const degreePart = fromMatch ? text.substring(0, text.lastIndexOf(' from ')).trim() : text;

                            return {
                                degree: degreePart,
                                school: school
                            };
                        });
                }
            }

            return { name, role, location, workHistory, education };
        }

        // Extract top companies
        function extractTopCompanies(workHistory) {
            const topTierCompanies = new Set([
                'Google', 'Microsoft', 'Amazon', 'Apple', 'Meta', 'Facebook',
                'Netflix', 'Tesla', 'SpaceX', 'Bloomberg', 'Goldman Sachs',
                'Morgan Stanley', 'Jane Street', 'Citadel', 'Two Sigma',
                'Stripe', 'Airbnb', 'Uber', 'Lyft', 'Twitter', 'X',
                'LinkedIn', 'Salesforce', 'Oracle', 'IBM', 'Intel', 'NVIDIA',
                'AMD', 'Qualcomm', 'Cisco', 'VMware', 'Adobe', 'Autodesk'
            ]);

            const companies = new Set();
            workHistory.forEach(job => {
                const company = job.company;
                for (const topCompany of topTierCompanies) {
                    if (company.includes(topCompany)) {
                        companies.add(topCompany);
                        break;
                    }
                }
            });

            return Array.from(companies);
        }

        // Extract career progression
        function extractCareerProgression(workHistory) {
            const sweRoles = workHistory.filter(job => {
                const title = job.title.toLowerCase();
                return title.includes('software') ||
                       title.includes('engineer') ||
                       title.includes('developer') ||
                       title.includes('swe');
            });

            return sweRoles.slice(0, 3).map(job => {
                const year = job.startDate.split('-')[0];
                return {
                    year,
                    title: job.title,
                    company: job.company
                };
            });
        }

        // Calculate total experience
        function calculateExperience(workHistory) {
            if (workHistory.length === 0) return 0;

            const firstJob = workHistory[workHistory.length - 1];
            const currentYear = new Date().getFullYear();
            const startYear = parseInt(firstJob.startDate.split('-')[0]);

            return currentYear - startYear;
        }

        // Render candidate card
        function renderCandidateCard(candidate) {
            const data = extractCandidateData(candidate);
            if (!data) {
                document.getElementById('candidate-content').innerHTML = '<p>No candidate data available</p>';
                return;
            }

            const topCompanies = extractTopCompanies(data.workHistory);
            const progression = extractCareerProgression(data.workHistory);
            const experience = calculateExperience(data.workHistory);

            // Get education summary - extract school from first degree
            let schoolName = 'Unknown';
            if (data.education.length > 0 && data.education[0].school) {
                schoolName = data.education[0].school;
            }

            const html = `
                <div class="candidate-header">
                    <div class="candidate-name">${escapeHtml(data.name)}</div>
                    <div class="candidate-role">${escapeHtml(data.role)}</div>
                    <div class="candidate-location">üìç ${escapeHtml(data.location)}</div>
                </div>

                <!-- Education Section -->
                <div class="linkedin-section">
                    <div class="linkedin-section-title">Education</div>
                    ${data.education.map(edu => `
                        <div class="linkedin-item">
                            <div class="linkedin-icon">üéì</div>
                            <div class="linkedin-content">
                                <div class="linkedin-title">${escapeHtml(edu.school)}</div>
                                <div class="linkedin-subtitle">${escapeHtml(edu.degree)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Experience Section -->
                <div class="linkedin-section">
                    <div class="linkedin-section-title">Experience</div>
                    ${data.workHistory.slice(0, 5).map(job => `
                        <div class="linkedin-item">
                            <div class="linkedin-icon">üíº</div>
                            <div class="linkedin-content">
                                <div class="linkedin-title">${escapeHtml(job.title)}</div>
                                <div class="linkedin-subtitle">${escapeHtml(job.company)}</div>
                                <div class="linkedin-meta">${escapeHtml(job.startDate)} - ${escapeHtml(job.endDate)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Evaluation Questions Section -->
                <div class="linkedin-section">
                    <div class="linkedin-section-title">Evaluation Criteria</div>

                    <div class="linkedin-item">
                        <div class="linkedin-icon">üèÜ</div>
                        <div class="linkedin-content">
                            <div class="linkedin-title">Educational Pedigree</div>
                            <div class="linkedin-subtitle">Top-tier institution assessment</div>
                        </div>
                    </div>

                    <div class="linkedin-item">
                        <div class="linkedin-icon">üè¢</div>
                        <div class="linkedin-content">
                            <div class="linkedin-title">Company Pedigree</div>
                            <div class="linkedin-subtitle">Employer quality: ${topCompanies.length > 0 ? topCompanies.join(', ') : 'N/A'}</div>
                        </div>
                    </div>

                    <div class="linkedin-item">
                        <div class="linkedin-icon">üìà</div>
                        <div class="linkedin-content">
                            <div class="linkedin-title">Career Trajectory</div>
                            <div class="linkedin-subtitle">${experience} years of experience</div>
                        </div>
                    </div>

                    <div class="linkedin-item">
                        <div class="linkedin-icon">üíª</div>
                        <div class="linkedin-content">
                            <div class="linkedin-title">Is Software Engineer</div>
                            <div class="linkedin-subtitle">Role verification</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('candidate-content').innerHTML = html;
        }

        // Render evaluation card
        function renderEvaluationCard(candidate) {
            const result = state.results[candidate.custom_id];
            if (!result) {
                document.getElementById('evaluation-content').innerHTML = '<div class="loading">No evaluation available</div>';
                return;
            }

            const llmOutput = result.response?.body?.choices?.[0]?.message?.content || '';

            // Parse JSON from LLM output
            const jsonMatch = llmOutput.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
            let evaluation = null;

            if (jsonMatch) {
                try {
                    evaluation = JSON.parse(jsonMatch[1]);
                } catch (e) {
                    console.error('Failed to parse evaluation JSON:', e);
                }
            }

            if (!evaluation) {
                document.getElementById('evaluation-content').innerHTML = `
                    <div class="reasoning">${escapeHtml(llmOutput)}</div>
                `;
                return;
            }

            // Store original data
            state.originalData = evaluation;

            // Use edited data if available
            const displayData = state.editedData || evaluation;
            const isEdited = state.editedData !== null;

            // Render evaluation
            const html = `
                <div class="recommendation">
                    <div class="recommendation-badge ${getBadgeClass(displayData.recommendation)}">
                        ${escapeHtml(displayData.recommendation || 'N/A')}
                        ${isEdited ? '<span class="edit-indicator">‚úèÔ∏è EDITED</span>' : ''}
                    </div>
                </div>

                <div class="reasoning">
                    <strong>Reasoning:</strong><br>
                    ${escapeHtml(displayData.reasoning || 'No reasoning provided')}
                </div>

                ${displayData.analysis ? renderAnalysis(displayData.analysis) : ''}
            `;

            document.getElementById('evaluation-content').innerHTML = html;
        }

        // Render analysis section
        function renderAnalysis(analysis) {
            const items = [];

            if (analysis.educational_pedigree) {
                items.push({
                    title: 'Educational Pedigree',
                    rating: analysis.educational_pedigree.rating,
                    reasoning: analysis.educational_pedigree.reasoning
                });
            }

            if (analysis.company_pedigree) {
                items.push({
                    title: 'Company Pedigree',
                    rating: analysis.company_pedigree.rating,
                    reasoning: analysis.company_pedigree.reasoning
                });
            }

            if (analysis.trajectory) {
                items.push({
                    title: 'Trajectory',
                    rating: analysis.trajectory.rating,
                    reasoning: analysis.trajectory.reasoning
                });
            }

            if (analysis.is_software_engineer) {
                items.push({
                    title: 'Is Software Engineer',
                    rating: analysis.is_software_engineer.value ? 'Yes' : 'No',
                    reasoning: analysis.is_software_engineer.reasoning
                });
            }

            return items.map(item => `
                <div class="analysis-item">
                    <h4>${item.title}</h4>
                    <div class="rating-badge ${getRatingClass(item.rating)}">${escapeHtml(item.rating)}</div>
                    <div class="analysis-reasoning">${escapeHtml(item.reasoning || '')}</div>
                </div>
            `).join('');
        }

        // Get badge class for recommendation
        function getBadgeClass(recommendation) {
            const rec = (recommendation || '').toLowerCase();
            if (rec.includes('strong yes')) return 'badge-strong-yes';
            if (rec.includes('yes')) return 'badge-yes';
            if (rec.includes('maybe')) return 'badge-maybe';
            if (rec.includes('strong no')) return 'badge-strong-no';
            if (rec.includes('no')) return 'badge-no';
            return 'badge-maybe';
        }

        // Get rating class
        function getRatingClass(rating) {
            const r = (rating || '').toLowerCase();
            if (r === 'great') return 'rating-great';
            if (r === 'good') return 'rating-good';
            if (r === 'average') return 'rating-average';
            if (r === 'weak') return 'rating-weak';
            if (r === 'none') return 'rating-none';
            return 'rating-average';
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Navigation
        function nextCandidate() {
            // Warn if unsaved edits
            if (state.editedData && !confirm('You have unsaved edits. Navigate away and lose changes?')) {
                return;
            }

            if (state.currentFilteredIndex < state.filteredIndices.length - 1) {
                state.currentFilteredIndex++;
                state.currentIndex = state.filteredIndices[state.currentFilteredIndex];
                state.editedData = null;
                state.originalData = null;
                state.isEditing = false;
                renderCurrentCandidate();
            }
        }

        function prevCandidate() {
            // Warn if unsaved edits
            if (state.editedData && !confirm('You have unsaved edits. Navigate away and lose changes?')) {
                return;
            }

            if (state.currentFilteredIndex > 0) {
                state.currentFilteredIndex--;
                state.currentIndex = state.filteredIndices[state.currentFilteredIndex];
                state.editedData = null;
                state.originalData = null;
                state.isEditing = false;
                renderCurrentCandidate();
            }
        }

        function skipCandidate() {
            const candidate = state.candidates[state.currentIndex];
            state.skipped.add(candidate.custom_id);
            state.reviewed.add(candidate.custom_id);
            updateStats();

            // If filtering by unreviewed, reapply filter
            if (state.filter === 'unreviewed') {
                applyFilter();
            } else {
                nextCandidate();
            }
        }

        // Rating
        async function rateCandidate(rating) {
            const candidate = state.candidates[state.currentIndex];
            const result = state.results[candidate.custom_id];

            if (!result) {
                alert('No evaluation available for this candidate');
                return;
            }

            // Extract data
            const messages = candidate.body?.messages || [];
            const systemMsg = messages.find(m => m.role === 'system');
            const userMsg = messages.find(m => m.role === 'user');
            const llmOutput = result.response?.body?.choices?.[0]?.message?.content || '';

            // Prepare edited LLM output if edited
            let editedLlmOutput = null;
            if (state.editedData) {
                // Format edited data as JSON string (similar to original LLM output format)
                editedLlmOutput = 'Here is the evaluation:\n\n```json\n' +
                    JSON.stringify(state.editedData, null, 2) +
                    '\n```';
            }

            // Prepare data
            const data = {
                custom_id: candidate.custom_id,
                candidate_name: extractCandidateName(candidate),
                input_prompt: {
                    system: systemMsg?.content || '',
                    user: userMsg?.content || ''
                },
                original_llm_output: llmOutput,
                edited_llm_output: editedLlmOutput,
                is_edited: state.editedData !== null,
                quality_score: rating,
                tags: state.editedData ? ['edited'] : [],
                notes: state.editedData ? 'User edited evaluation' : '',
                model: 'llama32-3b',
                starred_by: 'user',
                starred_at: new Date().toISOString()
            };

            // Save to API
            try {
                const response = await fetch('/api/gold-star', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Failed to save');
                }

                // Update state
                state.starred.set(candidate.custom_id, data);
                state.reviewed.add(candidate.custom_id);
                updateStats();

                // Show feedback
                showToast(`‚≠ê Rated ${rating}/10`);

                // Auto-advance - reapply filter if needed
                setTimeout(() => {
                    if (state.filter === 'unreviewed') {
                        applyFilter();
                    } else {
                        nextCandidate();
                    }
                }, 500);
            } catch (error) {
                console.error('Error saving rating:', error);
                alert('Failed to save rating. Please try again.');
            }
        }

        // Extract candidate name
        function extractCandidateName(candidate) {
            const messages = candidate.body?.messages || [];
            const userMsg = messages.find(m => m.role === 'user');
            if (!userMsg) return 'Unknown';

            const nameMatch = userMsg.content.match(/\*\*Candidate:\*\*\s*([^\n]+)/);
            return nameMatch ? nameMatch[1].trim() : 'Unknown';
        }

        // Update stats
        function updateStats() {
            document.getElementById('reviewed-count').textContent = state.reviewed.size;
            document.getElementById('total-count').textContent = state.candidates.length;
            document.getElementById('starred-count').textContent = state.starred.size;
            document.getElementById('skipped-count').textContent = state.skipped.size;
        }

        // Update progress
        function updateProgress() {
            const total = state.filteredIndices.length;
            const current = state.currentFilteredIndex + 1;
            const percent = total > 0 ? ((current / total) * 100).toFixed(2) : 0;

            document.getElementById('current-index').textContent = current;
            document.getElementById('total-candidates').textContent = total;
            document.getElementById('progress-percent').textContent = percent;
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // ESC always closes help overlay first
                if (e.key === 'Escape') {
                    const helpOverlay = document.getElementById('help-overlay');
                    if (!helpOverlay.classList.contains('hidden')) {
                        e.preventDefault();
                        hideHelp();
                        return;
                    }
                }

                // Don't trigger if in edit mode
                if (state.isEditing) {
                    if (e.key === 'Escape') cancelEdits();
                    return;
                }

                // Rating
                if (e.key >= '1' && e.key <= '9') {
                    e.preventDefault();
                    rateCandidate(parseInt(e.key));
                }

                // Navigation
                if (e.key === 'n' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextCandidate();
                }

                if (e.key === 'p' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    prevCandidate();
                }

                if (e.key === 's') {
                    e.preventDefault();
                    skipCandidate();
                }

                if (e.key === 'e') {
                    e.preventDefault();
                    toggleEditMode();
                }

                if (e.key === '?') {
                    e.preventDefault();
                    showHelp();
                }
            });
        }

        // Edit mode
        function toggleEditMode() {
            state.isEditing = true;

            // Show save/cancel buttons, hide edit button
            document.getElementById('edit-btn').classList.add('hidden');
            document.getElementById('save-btn').classList.remove('hidden');
            document.getElementById('cancel-btn').classList.remove('hidden');

            // Make evaluation editable
            renderEditableEvaluation();
        }

        function renderEditableEvaluation() {
            const candidate = state.candidates[state.currentIndex];
            const result = state.results[candidate.custom_id];
            if (!result) return;

            const llmOutput = result.response?.body?.choices?.[0]?.message?.content || '';
            const jsonMatch = llmOutput.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);

            let evaluation = null;
            if (jsonMatch) {
                try {
                    evaluation = JSON.parse(jsonMatch[1]);
                } catch (e) {
                    console.error('Failed to parse evaluation JSON:', e);
                    return;
                }
            }

            if (!evaluation) return;

            // Store original if not already stored
            if (!state.originalData) {
                state.originalData = JSON.parse(JSON.stringify(evaluation));
            }

            // Render editable version
            const html = `
                <div class="recommendation">
                    <select class="editable-select" id="edit-recommendation">
                        <option value="Strong Yes" ${evaluation.recommendation === 'Strong Yes' ? 'selected' : ''}>‚≠ê Strong Yes</option>
                        <option value="Yes" ${evaluation.recommendation === 'Yes' ? 'selected' : ''}>‚úì Yes</option>
                        <option value="Maybe" ${evaluation.recommendation === 'Maybe' ? 'selected' : ''}>? Maybe</option>
                        <option value="No" ${evaluation.recommendation === 'No' ? 'selected' : ''}>‚úó No</option>
                        <option value="Strong No" ${evaluation.recommendation === 'Strong No' ? 'selected' : ''}>‚õî Strong No</option>
                    </select>
                    <span class="edit-indicator">‚úèÔ∏è EDITING</span>
                </div>

                <div class="reasoning">
                    <strong>Reasoning:</strong><br>
                    <textarea class="editable-textarea" id="edit-reasoning">${escapeHtml(evaluation.reasoning || '')}</textarea>
                </div>

                ${evaluation.analysis ? renderEditableAnalysis(evaluation.analysis) : ''}
            `;

            document.getElementById('evaluation-content').innerHTML = html;
        }

        function renderEditableAnalysis(analysis) {
            const items = [];

            if (analysis.educational_pedigree) {
                items.push({
                    id: 'educational_pedigree',
                    title: 'Educational Pedigree',
                    rating: analysis.educational_pedigree.rating,
                    reasoning: analysis.educational_pedigree.reasoning
                });
            }

            if (analysis.company_pedigree) {
                items.push({
                    id: 'company_pedigree',
                    title: 'Company Pedigree',
                    rating: analysis.company_pedigree.rating,
                    reasoning: analysis.company_pedigree.reasoning
                });
            }

            if (analysis.trajectory) {
                items.push({
                    id: 'trajectory',
                    title: 'Trajectory',
                    rating: analysis.trajectory.rating,
                    reasoning: analysis.trajectory.reasoning
                });
            }

            if (analysis.is_software_engineer) {
                items.push({
                    id: 'is_software_engineer',
                    title: 'Is Software Engineer',
                    rating: analysis.is_software_engineer.value ? 'Yes' : 'No',
                    reasoning: analysis.is_software_engineer.reasoning,
                    isBoolean: true
                });
            }

            return items.map(item => `
                <div class="analysis-item">
                    <h4>${item.title}</h4>
                    ${item.isBoolean ? `
                        <select class="editable-rating-select" id="edit-${item.id}-rating">
                            <option value="Yes" ${item.rating === 'Yes' ? 'selected' : ''}>Yes</option>
                            <option value="No" ${item.rating === 'No' ? 'selected' : ''}>No</option>
                        </select>
                    ` : `
                        <select class="editable-rating-select" id="edit-${item.id}-rating">
                            <option value="Great" ${item.rating === 'Great' ? 'selected' : ''}>Great</option>
                            <option value="Good" ${item.rating === 'Good' ? 'selected' : ''}>Good</option>
                            <option value="Average" ${item.rating === 'Average' ? 'selected' : ''}>Average</option>
                            <option value="Weak" ${item.rating === 'Weak' ? 'selected' : ''}>Weak</option>
                            <option value="None" ${item.rating === 'None' ? 'selected' : ''}>None</option>
                        </select>
                    `}
                    <br><br>
                    <textarea class="editable-textarea" id="edit-${item.id}-reasoning" style="min-height: 60px;">${escapeHtml(item.reasoning || '')}</textarea>
                </div>
            `).join('');
        }

        function saveEdits() {
            // Collect edited data
            const editedData = {
                recommendation: document.getElementById('edit-recommendation')?.value || '',
                reasoning: document.getElementById('edit-reasoning')?.value || '',
                analysis: {}
            };

            // Collect analysis edits
            const analysisFields = ['educational_pedigree', 'company_pedigree', 'trajectory', 'is_software_engineer'];

            for (const field of analysisFields) {
                const ratingEl = document.getElementById(`edit-${field}-rating`);
                const reasoningEl = document.getElementById(`edit-${field}-reasoning`);

                if (ratingEl && reasoningEl) {
                    if (field === 'is_software_engineer') {
                        editedData.analysis[field] = {
                            value: ratingEl.value === 'Yes',
                            reasoning: reasoningEl.value
                        };
                    } else {
                        editedData.analysis[field] = {
                            rating: ratingEl.value,
                            reasoning: reasoningEl.value
                        };
                    }
                }
            }

            // Store edited data
            state.editedData = editedData;

            // Exit edit mode
            state.isEditing = false;
            document.getElementById('edit-btn').classList.remove('hidden');
            document.getElementById('save-btn').classList.add('hidden');
            document.getElementById('cancel-btn').classList.add('hidden');

            // Re-render with edited data
            renderCurrentCandidate();

            // Show confirmation
            showToast('‚úèÔ∏è Edits saved! Rate to save permanently.');

            showToast('‚úèÔ∏è Edits saved! Rate to save permanently.');
        }

        function cancelEdits() {
            state.isEditing = false;
            state.editedData = null;

            // Show edit button, hide save/cancel
            document.getElementById('edit-btn').classList.remove('hidden');
            document.getElementById('save-btn').classList.add('hidden');
            document.getElementById('cancel-btn').classList.add('hidden');

            // Re-render original
            renderCurrentCandidate();
        }

        // Help overlay
        window.showHelp = function() {
            const overlay = document.getElementById('help-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        }

        window.hideHelp = function() {
            const overlay = document.getElementById('help-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;

            // Set color based on type
            if (type === 'error') {
                toast.style.background = '#dc3545';
            } else if (type === 'warning') {
                toast.style.background = '#ffc107';
                toast.style.color = '#856404';
            }

            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
    </script>
</body>
</html>

