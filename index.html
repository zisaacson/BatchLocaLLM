<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Results - Dataset Selector</title>
    <link rel="stylesheet" href="static/css/shared.css">
    <style>
        .subtitle {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            font-size: 16px;
        }
        
        .dataset-grid {
            display: grid;
            gap: 20px;
        }
        
        .dataset-card {
            background: var(--surface-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-md);
        }

        .dataset-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .dataset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .dataset-name {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .dataset-count {
            background: var(--primary-gradient);
            padding: 6px 12px;
            border-radius: var(--radius-pill);
            font-size: 14px;
            color: white;
            font-weight: bold;
            box-shadow: var(--shadow-sm);
        }

        .results-list {
            margin-top: var(--spacing-md);
        }

        .results-header {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
        }

        .result-item {
            background: var(--surface-light);
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            font-size: 13px;
            font-family: var(--font-mono);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .result-name {
            color: var(--text-primary);
        }

        .result-badge {
            background: var(--rating-great);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: bold;
        }

        .no-results {
            color: var(--text-muted);
            font-style: italic;
            padding: 12px;
            text-align: center;
            background: var(--surface-light);
            border-radius: var(--radius-sm);
        }

        .view-button {
            margin-top: var(--spacing-md);
            padding: 10px 20px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .view-button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        .view-button:disabled {
            background: var(--rating-none);
            color: white;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .gpu-status-box {
            background: var(--surface-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .gpu-status-title {
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
        }

        .gpu-info {
            color: var(--text-secondary);
        }

        .quick-links {
            background: var(--surface-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .quick-links-title {
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            font-weight: 600;
            font-size: 18px;
        }

        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .quick-link-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--primary-gradient);
            color: white;
            text-decoration: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .quick-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .quick-link-btn.secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Benchmark Results Viewer</h1>
        <p class="subtitle">Select a dataset to compare model responses</p>

        <div class="quick-links">
            <h3 class="quick-links-title">‚ö° Quick Links</h3>
            <div class="quick-links-grid">
                <a href="/curate" class="quick-link-btn secondary">
                    <span>‚≠ê</span>
                    <span>Gold-Star Curation</span>
                </a>
                <a href="/table" class="quick-link-btn">
                    <span>üìä</span>
                    <span>Table View</span>
                </a>
            </div>
        </div>

        <div id="gpuStatus" class="gpu-status-box">
            <h3 class="gpu-status-title">üéÆ GPU Status</h3>
            <div id="gpuInfo" class="gpu-info">Loading...</div>
        </div>

        <div id="error" style="display: none;" class="error"></div>
        <div id="loading" class="loading">üîç Discovering datasets and results...</div>
        <div id="datasets" class="dataset-grid"></div>
    </div>

    <script src="static/js/parsers.js"></script>
    <script>
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');
        const datasetsDiv = document.getElementById('datasets');
        
        async function init() {
            try {
                const response = await fetch('/api/discover');
                if (!response.ok) throw new Error('Failed to discover datasets');
                
                const datasets = await response.json();
                loadingDiv.style.display = 'none';
                
                if (Object.keys(datasets).length === 0) {
                    datasetsDiv.innerHTML = '<div class="no-results">No datasets found</div>';
                    return;
                }
                
                renderDatasets(datasets);
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }
        
        function renderDatasets(datasets) {
            datasetsDiv.innerHTML = Object.entries(datasets)
                .sort((a, b) => b[1].count - a[1].count)
                .map(([name, info]) => {
                    const hasResults = info.results && info.results.length > 0;
                    
                    return `
                        <div class="dataset-card" onclick="${hasResults ? `viewDataset('${name}')` : ''}">
                            <div class="dataset-header">
                                <div class="dataset-name">${name}</div>
                                <div class="dataset-count">${info.count.toLocaleString()} candidates</div>
                            </div>
                            
                            <div class="results-list">
                                <div class="results-header">
                                    ${hasResults ? `${info.results.length} Model Result${info.results.length > 1 ? 's' : ''}` : 'No Results Yet'}
                                </div>
                                ${hasResults ?
                                    info.results.map(r => `
                                        <div class="result-item">
                                            <span class="result-name">${r.model ? extractModelName(r.model) : extractModelName(r.file)}</span>
                                            <span class="result-badge">‚úì ${r.count.toLocaleString()}</span>
                                        </div>
                                    `).join('') :
                                    '<div class="no-results">No model results available for this dataset</div>'
                                }
                            </div>
                            
                            ${hasResults ? 
                                `<button class="view-button" onclick="event.stopPropagation(); viewDataset('${name}')">
                                    View Comparison ‚Üí
                                </button>` :
                                `<button class="view-button" disabled>No Results to Compare</button>`
                            }
                        </div>
                    `;
                }).join('');
        }
        
        function extractModelName(filename) {
            // Extract model name from filename
            const lower = filename.toLowerCase();

            // Handle benchmark filenames (benchmarks/raw/vllm-native-gemma3-4b-5000-2025-10-28.jsonl)
            if (lower.includes('gemma3-4b') || lower.includes('gemma3_4b')) return 'Gemma 3 4B';
            if (lower.includes('gemma2-9b') || lower.includes('gemma2_9b')) return 'Gemma 2 9B';
            if (lower.includes('gemma2-2b') || lower.includes('gemma2_2b')) return 'Gemma 2 2B';

            if (lower.includes('llama32-3b') || lower.includes('llama32_3b')) return 'Llama 3.2 3B';
            if (lower.includes('llama32-1b') || lower.includes('llama32_1b')) return 'Llama 3.2 1B';

            if (lower.includes('qwen3-4b') || lower.includes('qwen3_4b')) return 'Qwen 3 4B';
            if (lower.includes('qwen2.5-3b') || lower.includes('qwen')) return 'Qwen 2.5 3B';

            if (lower.includes('olmo2-7b') || lower.includes('olmo2_7b')) return 'OLMo 2 7B';
            if (lower.includes('olmo2-1b') || lower.includes('olmo2_1b')) return 'OLMo 2 1B';

            // Return cleaned filename if no match
            return filename.replace('benchmarks/raw/', '')
                          .replace('vllm-native-', '')
                          .replace(/-\d{4}-\d{2}-\d{2}\.jsonl$/, '')
                          .replace('.jsonl', '');
        }
        
        function viewDataset(datasetName) {
            // Navigate to table viewer with dataset parameter
            window.location.href = `table_view.html?dataset=${encodeURIComponent(datasetName)}`;
        }

        // GPU status updates
        async function updateGPUStatus() {
            try {
                const response = await fetch('/api/gpu');
                if (response.ok) {
                    const data = await response.json();
                    const gpuInfo = document.getElementById('gpuInfo');

                    if (data.gpus && data.gpus.length > 0) {
                        const gpu = data.gpus[0];
                        const memPercent = ((parseInt(gpu.memory_used) / parseInt(gpu.memory_total)) * 100).toFixed(1);

                        let html = `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="font-size: 11px; color: #8b949e;">GPU</div>
                                    <div style="font-size: 14px; color: #c9d1d9;">${gpu.name}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #8b949e;">Utilization</div>
                                    <div style="font-size: 18px; color: #58a6ff; font-weight: bold;">${gpu.utilization}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #8b949e;">Memory</div>
                                    <div style="font-size: 14px; color: #c9d1d9;">${gpu.memory_used} / ${gpu.memory_total} MB (${memPercent}%)</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #8b949e;">Temperature</div>
                                    <div style="font-size: 14px; color: #c9d1d9;">${gpu.temperature}¬∞C</div>
                                </div>
                            </div>
                        `;

                        if (data.progress && Object.keys(data.progress).length > 0) {
                            html += '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #30363d;">';
                            html += '<div style="font-size: 11px; color: #8b949e; margin-bottom: 8px;">RUNNING JOBS</div>';
                            for (const [log, progress] of Object.entries(data.progress)) {
                                html += `<div style="font-size: 12px; color: #58a6ff; font-family: monospace;">${log}: ${progress}</div>`;
                            }
                            html += '</div>';
                        }

                        gpuInfo.innerHTML = html;
                    } else {
                        gpuInfo.innerHTML = '<div style="color: #8b949e;">No GPU detected</div>';
                    }
                }
            } catch (e) {
                console.error('GPU status error:', e);
            }
        }

        init();
        updateGPUStatus();
        setInterval(updateGPUStatus, 5000); // Update every 5 seconds
    </script>
</body>
</html>

