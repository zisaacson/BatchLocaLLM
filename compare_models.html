<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Comparison - vLLM Batch Benchmarks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            color: #58a6ff;
            margin-bottom: 20px;
        }
        
        .section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            color: #58a6ff;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .criteria-box {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .model-card {
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .model-card:hover {
            border-color: #58a6ff;
        }
        
        .model-card.selected {
            border-color: #3fb950;
            background: #0d1b1a;
        }
        
        .model-card input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .model-name {
            font-size: 16px;
            font-weight: bold;
            color: #c9d1d9;
            margin-bottom: 8px;
        }
        
        .model-stats {
            font-size: 12px;
            color: #8b949e;
            margin-top: 5px;
        }
        
        .model-stat {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .comparison-table th {
            background: #0d1117;
            padding: 12px;
            text-align: left;
            border: 1px solid #30363d;
            color: #58a6ff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .comparison-table td {
            padding: 12px;
            border: 1px solid #30363d;
            vertical-align: top;
        }
        
        .comparison-table tr:hover {
            background: #161b22;
        }
        
        .response-box {
            background: #0d1117;
            border-radius: 4px;
            padding: 10px;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .recommendation {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .rec-strong-yes { background: #238636; color: white; }
        .rec-yes { background: #3fb950; color: white; }
        .rec-maybe { background: #d29922; color: white; }
        .rec-no { background: #da3633; color: white; }
        .rec-strong-no { background: #a40e26; color: white; }
        .rec-error { background: #6e7681; color: white; }
        
        .diff-indicator {
            color: #f85149;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            color: #8b949e;
            font-size: 14px;
        }
        
        .control-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .control-group select {
            padding: 6px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }
        
        .error {
            background: #da3633;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .candidate-header {
            font-weight: bold;
            color: #58a6ff;
            margin-bottom: 5px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            cursor: pointer;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #30363d;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .current-page {
            padding: 8px 16px;
            color: #58a6ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Model Comparison Dashboard</h1>
        
        <!-- Evaluation Criteria -->
        <div class="section">
            <div class="section-title">üìã Evaluation Criteria</div>
            <div class="criteria-box" id="criteriaBox">Loading...</div>
        </div>
        
        <!-- Model Selection -->
        <div class="section">
            <div class="section-title">üéØ Select Models to Compare</div>
            <div class="model-grid" id="modelGrid">
                <div class="loading">Loading models...</div>
            </div>
        </div>
        
        <!-- Comparison Controls -->
        <div class="section">
            <div class="controls">
                <div class="control-group">
                    <input type="checkbox" id="showOnlyDiff">
                    <label for="showOnlyDiff">Show only different recommendations</label>
                </div>
                <div class="control-group">
                    <label for="perPageSelect">Results per page:</label>
                    <select id="perPageSelect">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Comparison Table -->
        <div class="section">
            <div class="section-title">üìä Side-by-Side Comparison</div>
            <div id="comparisonContainer">
                <div class="loading">Select at least 2 models to compare</div>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>
    
    <script>
        let metadata = null;
        let selectedModels = [];
        let allResults = {};
        let currentPage = 1;
        let perPage = 25;
        let showOnlyDiff = false;
        
        // Load metadata on page load
        async function loadMetadata() {
            try {
                const response = await fetch('/api/metadata');
                metadata = await response.json();
                
                displayCriteria();
                displayModelCards();
            } catch (error) {
                console.error('Error loading metadata:', error);
                document.getElementById('criteriaBox').textContent = 'Error loading metadata. Make sure serve_results.py is running.';
            }
        }
        
        function displayCriteria() {
            const dataset = metadata.datasets['batch_5k.jsonl'];
            if (dataset && dataset.criteria && dataset.criteria.full_prompt) {
                document.getElementById('criteriaBox').textContent = dataset.criteria.full_prompt;
            }
        }
        
        function displayModelCards() {
            const grid = document.getElementById('modelGrid');
            grid.innerHTML = '';
            
            metadata.runs.forEach(run => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.onclick = () => toggleModel(run.run_id, card);
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `model-${run.run_id}`;
                checkbox.onclick = (e) => e.stopPropagation();
                checkbox.onchange = () => toggleModel(run.run_id, card);
                
                const stats = metadata.runs.find(r => r.run_id === run.run_id);
                const modelMeta = Object.values(metadata.models).find(m => m.name === run.model);
                
                card.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        ${checkbox.outerHTML}
                        <div style="flex: 1;">
                            <div class="model-name">${run.model}</div>
                            <div class="model-stats">
                                <div class="model-stat">
                                    <span>Success Rate:</span>
                                    <span>${run.success_rate.toFixed(1)}%</span>
                                </div>
                                <div class="model-stat">
                                    <span>Results:</span>
                                    <span>${stats ? '5000' : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        async function toggleModel(runId, card) {
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                card.classList.add('selected');
                selectedModels.push(runId);
                await loadModelResults(runId);
            } else {
                card.classList.remove('selected');
                selectedModels = selectedModels.filter(id => id !== runId);
                delete allResults[runId];
            }
            
            if (selectedModels.length >= 2) {
                renderComparison();
            } else {
                document.getElementById('comparisonContainer').innerHTML = '<div class="loading">Select at least 2 models to compare</div>';
            }
        }
        
        async function loadModelResults(runId) {
            const run = metadata.runs.find(r => r.run_id === runId);
            if (!run) return;
            
            try {
                const response = await fetch(`/api/results?model=${encodeURIComponent(run.results_file)}`);
                const results = await response.json();
                allResults[runId] = results;
            } catch (error) {
                console.error(`Error loading results for ${runId}:`, error);
            }
        }
        
        function renderComparison() {
            if (selectedModels.length < 2) return;

            const container = document.getElementById('comparisonContainer');
            const firstModel = selectedModels[0];
            const firstResults = allResults[firstModel];

            if (!firstResults) {
                container.innerHTML = '<div class="loading">Loading results...</div>';
                return;
            }

            // Filter results if needed
            let resultsToShow = firstResults.map((_, idx) => idx);

            if (showOnlyDiff) {
                resultsToShow = resultsToShow.filter(idx => {
                    const recs = selectedModels.map(modelId => {
                        const result = allResults[modelId][idx];
                        return extractRecommendation(result);
                    });
                    return new Set(recs).size > 1; // Different recommendations
                });
            }

            // Pagination
            const totalPages = Math.ceil(resultsToShow.length / perPage);
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pageResults = resultsToShow.slice(start, end);

            // Build table
            let html = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th style="width: 200px;">Candidate</th>
                            ${selectedModels.map(modelId => {
                                const run = metadata.runs.find(r => r.run_id === modelId);
                                return `<th>${run.model}</th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageResults.forEach(idx => {
                const firstResult = firstResults[idx];
                const candidate = extractCandidateInfo(firstResult);

                html += `<tr>`;
                html += `<td>
                    <div class="candidate-header">${candidate.name}</div>
                    <div style="font-size: 12px; color: #8b949e; margin-top: 4px;">${candidate.role}</div>
                    ${candidate.location ? `<div style="font-size: 11px; color: #6e7681; margin-top: 2px;">üìç ${candidate.location}</div>` : ''}
                </td>`;

                selectedModels.forEach(modelId => {
                    const result = allResults[modelId][idx];
                    html += `<td>${formatResponse(result)}</td>`;
                });

                html += `</tr>`;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;

            // Render pagination
            renderPagination(totalPages);
        }

        function extractCandidateInfo(result) {
            try {
                // Try to extract from request body
                const body = result.body || result.request?.body;
                if (body && body.messages) {
                    const userMsg = body.messages.find(m => m.role === 'user');
                    if (userMsg) {
                        const content = userMsg.content;

                        // Extract candidate name
                        const nameMatch = content.match(/\*\*Candidate:\*\* (.+)/);
                        const name = nameMatch ? nameMatch[1].trim() : 'Unknown';

                        // Extract current role
                        const roleMatch = content.match(/\*\*Current Role:\*\* (.+)/);
                        const role = roleMatch ? roleMatch[1].trim() : '';

                        // Extract location
                        const locationMatch = content.match(/\*\*Location:\*\* (.+)/);
                        const location = locationMatch ? locationMatch[1].trim() : '';

                        return {
                            name: name,
                            role: role,
                            location: location,
                            display: `${name}${role ? ' (' + role + ')' : ''}`
                        };
                    }
                }
                return {
                    name: 'Unknown',
                    role: '',
                    location: '',
                    display: result.custom_id ? result.custom_id.substring(0, 36) : 'Unknown'
                };
            } catch {
                return {
                    name: 'Unknown',
                    role: '',
                    location: '',
                    display: 'Unknown'
                };
            }
        }

        function extractRecommendation(result) {
            try {
                const content = result.response?.body?.choices?.[0]?.message?.content || '';
                const jsonMatch = content.match(/\{[\s\S]*"recommendation":\s*"([^"]+)"[\s\S]*\}/);
                if (jsonMatch) return jsonMatch[1];
                return 'Error';
            } catch {
                return 'Error';
            }
        }

        function formatResponse(result) {
            try {
                const statusCode = result.response?.status_code;
                if (statusCode !== 200) {
                    return `<div class="response-box"><span class="recommendation rec-error">ERROR</span><br>Status: ${statusCode}</div>`;
                }

                const content = result.response?.body?.choices?.[0]?.message?.content || '';
                const rec = extractRecommendation(result);
                const recClass = rec.toLowerCase().replace(/\s+/g, '-');

                // Try to parse JSON for better display
                try {
                    const parsed = JSON.parse(content);
                    return `
                        <div class="response-box">
                            <span class="recommendation rec-${recClass}">${rec}</span>
                            <div style="margin-top: 8px; font-size: 12px; color: #8b949e;">
                                ${parsed.reasoning || ''}
                            </div>
                        </div>
                    `;
                } catch {
                    return `
                        <div class="response-box">
                            <span class="recommendation rec-${recClass}">${rec}</span>
                            <div style="margin-top: 8px; font-size: 11px; color: #6e7681; max-height: 100px; overflow: hidden;">
                                ${content.substring(0, 200)}...
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                return `<div class="response-box"><span class="recommendation rec-error">Parse Error</span></div>`;
            }
        }

        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(1)">First</button>
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">Previous</button>
                <span class="current-page">Page ${currentPage} of ${totalPages}</span>
                <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Next</button>
                <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${totalPages})">Last</button>
            `;
            pagination.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            renderComparison();
        }
        
        // Event listeners
        document.getElementById('showOnlyDiff').addEventListener('change', (e) => {
            showOnlyDiff = e.target.checked;
            renderComparison();
        });
        
        document.getElementById('perPageSelect').addEventListener('change', (e) => {
            perPage = parseInt(e.target.value);
            currentPage = 1;
            renderComparison();
        });
        
        // Initialize
        loadMetadata();
    </script>
</body>
</html>

