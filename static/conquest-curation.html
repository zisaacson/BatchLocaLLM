<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conquest Curation System</title>
    <link rel="stylesheet" href="/static/css/conquest-ui.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="logo">‚öîÔ∏è Conquest Curation</h1>
            <div class="header-stats">
                <div class="stat">
                    <span class="stat-label">Total</span>
                    <span class="stat-value" id="stat-total">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Pending</span>
                    <span class="stat-value" id="stat-pending">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Agreement</span>
                    <span class="stat-value" id="stat-agreement">0%</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>Conquest Type</h3>
                <select id="conquest-type-selector" class="conquest-selector">
                    <option value="">Loading...</option>
                </select>
            </div>

            <div class="sidebar-section">
                <h3>Tasks</h3>
                <div class="filters">
                    <input type="text" id="search-box" class="search-box" placeholder="üîç Search by name, company, role...">
                    <select id="filter-status" class="filter-select">
                        <option value="all">All Tasks</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="gold-star">Gold Star</option>
                    </select>
                </div>
                <div class="task-list" id="task-list">
                    <div class="loading">Loading tasks...</div>
                </div>
                <div class="pagination" id="pagination" style="display: none;">
                    <button class="pagination-btn" id="prev-page">‚Üê Prev</button>
                    <span class="pagination-info" id="page-info">Page 1</span>
                    <button class="pagination-btn" id="next-page">Next ‚Üí</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Actions</h3>
                <button class="btn btn-primary" id="export-btn">
                    üì¶ Export Dataset
                </button>
                <button class="btn btn-secondary" id="refresh-btn">
                    üîÑ Refresh
                </button>
                <button class="btn btn-gold-star" id="bulk-gold-star-btn" style="display: none;">
                    ‚≠ê Gold Star Selected (<span id="selected-count">0</span>)
                </button>
            </div>

            <div class="sidebar-section">
                <h3>Keyboard Shortcuts</h3>
                <div class="shortcuts">
                    <div class="shortcut">
                        <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate tasks
                    </div>
                    <div class="shortcut">
                        <kbd>Ctrl</kbd> + <kbd>S</kbd> Save annotation
                    </div>
                    <div class="shortcut">
                        <kbd>Ctrl</kbd> + <kbd>G</kbd> Gold star
                    </div>
                    <div class="shortcut">
                        <kbd>Ctrl</kbd> + <kbd>E</kbd> Export
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div id="no-task-selected" class="empty-state">
                <div class="empty-icon">üìã</div>
                <h2>No Task Selected</h2>
                <p>Select a task from the sidebar to begin curation</p>
            </div>

            <div id="task-viewer" class="task-viewer" style="display: none;">
                <!-- Task Header -->
                <div class="task-header">
                    <div class="task-title" id="task-title">Loading...</div>
                    <div class="task-meta">
                        <span class="task-id" id="task-id"></span>
                        <span class="task-status" id="task-status"></span>
                    </div>
                </div>

                <!-- Two-Column Layout -->
                <div class="two-column-layout">
                    <!-- Left Column: Data Sources -->
                    <div class="column data-column">
                        <h2 class="column-title">üìä Data Sources</h2>
                        <div id="data-sources" class="data-sources">
                            <!-- Dynamically rendered based on schema -->
                        </div>
                    </div>

                    <!-- Right Column: Questions & Answers -->
                    <div class="column questions-column">
                        <h2 class="column-title">‚ùì Evaluation</h2>
                        
                        <!-- LLM Prediction (if available) -->
                        <div id="llm-prediction" class="prediction-section" style="display: none;">
                            <h3 class="section-title">ü§ñ LLM Prediction</h3>
                            <div id="llm-answers" class="answers-grid">
                                <!-- Dynamically rendered -->
                            </div>
                        </div>

                        <!-- Human Annotation -->
                        <div class="annotation-section">
                            <h3 class="section-title">üë§ Your Evaluation</h3>
                            <form id="annotation-form" class="annotation-form">
                                <!-- Dynamically rendered based on schema -->
                            </form>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" id="copy-llm-btn">
                                üìã Copy LLM Answers
                            </button>
                            <button type="button" class="btn btn-gold-star" id="gold-star-btn" title="Mark as gold-star for training dataset">
                                ‚≠ê Gold Star
                            </button>
                            <button type="submit" form="annotation-form" class="btn btn-primary">
                                ‚úÖ Submit Annotation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Export Dataset</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Export Format</label>
                    <select id="export-format" class="form-control">
                        <option value="icl">In-Context Learning (ICL)</option>
                        <option value="finetuning">Fine-tuning</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Minimum Agreement Score</label>
                    <input type="number" id="export-min-agreement" class="form-control" 
                           value="0.8" min="0" max="1" step="0.1">
                </div>
                <div class="form-group">
                    <label>Minimum Annotations</label>
                    <input type="number" id="export-min-annotations" class="form-control" 
                           value="1" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="export-cancel">Cancel</button>
                <button class="btn btn-primary" id="export-confirm">Export</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Scripts -->
    <script src="/static/js/conquest-templates.js"></script>
    <script src="/static/js/conquest-renderer.js"></script>
    <script src="/static/js/label-studio-api.js"></script>
    <script src="/static/js/keyboard-shortcuts.js"></script>
    
    <script>
        // Main application logic
        let currentSchema = null;
        let currentTask = null;
        let currentConquestType = null;
        let tasks = [];
        let currentTaskIndex = -1;
        let currentPage = 1;
        const TASKS_PER_PAGE = 50;

        // Initialize app
        async function init() {
            await loadSchemas();
            await loadStats();
            setupEventListeners();
            setupKeyboardShortcuts();
        }

        // Load available conquest schemas
        async function loadSchemas() {
            try {
                const schemas = await API.getSchemas();
                const selector = document.getElementById('conquest-type-selector');
                selector.innerHTML = schemas.map(s => 
                    `<option value="${s.id}">${s.name} (${s.questionCount} questions)</option>`
                ).join('');
                
                if (schemas.length > 0) {
                    selector.value = schemas[0].id;
                    await onConquestTypeChange();
                }
            } catch (error) {
                showToast('Failed to load schemas', 'error');
                console.error(error);
            }
        }

        // Load tasks for selected conquest type
        async function loadTasks() {
            if (!currentConquestType) return;
            
            try {
                const response = await API.getTasks(currentConquestType);
                tasks = response.tasks || [];
                renderTaskList();
                
                if (tasks.length > 0) {
                    selectTask(0);
                }
            } catch (error) {
                showToast('Failed to load tasks', 'error');
                console.error(error);
            }
        }

        // Load statistics
        async function loadStats() {
            if (!currentConquestType) return;
            
            try {
                const stats = await API.getStats(currentConquestType);
                document.getElementById('stat-total').textContent = stats.total_tasks;
                document.getElementById('stat-pending').textContent = stats.pending_tasks;
                document.getElementById('stat-agreement').textContent = 
                    `${(stats.average_agreement * 100).toFixed(0)}%`;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Render task list in sidebar
        function renderTaskList() {
            const taskList = document.getElementById('task-list');
            const filterStatus = document.getElementById('filter-status').value;
            const searchQuery = document.getElementById('search-box').value.toLowerCase();

            // Filter tasks
            const filteredTasks = tasks.filter(task => {
                const isAnnotated = task.annotations && task.annotations.length > 0;
                const isGoldStar = task.meta?.gold_star === true;

                // Status filter
                let statusMatch = true;
                if (filterStatus === 'pending') statusMatch = !isAnnotated;
                else if (filterStatus === 'completed') statusMatch = isAnnotated;
                else if (filterStatus === 'gold-star') statusMatch = isGoldStar;

                // Search filter
                let searchMatch = true;
                if (searchQuery) {
                    const name = (task.data.name || '').toLowerCase();
                    const company = (task.data.company || '').toLowerCase();
                    const role = (task.data.role || '').toLowerCase();
                    searchMatch = name.includes(searchQuery) ||
                                  company.includes(searchQuery) ||
                                  role.includes(searchQuery);
                }

                return statusMatch && searchMatch;
            });

            if (filteredTasks.length === 0) {
                taskList.innerHTML = '<div class="empty-state-small">No tasks match filter</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            // Pagination
            const totalPages = Math.ceil(filteredTasks.length / TASKS_PER_PAGE);
            const startIndex = (currentPage - 1) * TASKS_PER_PAGE;
            const endIndex = startIndex + TASKS_PER_PAGE;
            const paginatedTasks = filteredTasks.slice(startIndex, endIndex);

            // Update pagination controls
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');

            if (totalPages > 1) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${filteredTasks.length} tasks)`;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
            } else {
                pagination.style.display = 'none';
            }

            taskList.innerHTML = paginatedTasks.map((task, index) => {
                const isAnnotated = task.annotations && task.annotations.length > 0;
                const statusClass = isAnnotated ? 'completed' : 'pending';
                const statusIcon = isAnnotated ? '‚úÖ' : '‚è≥';
                const isGoldStar = task.meta?.gold_star === true;
                const goldStarIcon = isGoldStar ? '‚≠ê' : '';

                return `
                    <div class="task-item ${statusClass}" data-index="${index}" data-task-id="${task.id}">
                        <div class="task-item-checkbox">
                            <input type="checkbox" class="task-checkbox" data-task-id="${task.id}" onclick="event.stopPropagation()">
                        </div>
                        <div class="task-item-content">
                            <div class="task-item-header">
                                <span class="task-item-icon">${statusIcon}</span>
                                <span class="task-item-title">${task.data.name || `Task ${task.id}`}</span>
                                ${goldStarIcon ? `<span class="task-gold-star">${goldStarIcon}</span>` : ''}
                            </div>
                            <div class="task-item-meta">
                                <span class="task-item-id">#${task.id}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            document.querySelectorAll('.task-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    selectTask(index);
                });
            });

            // Add checkbox handlers
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateBulkGoldStarButton);
            });
        }

        function updateBulkGoldStarButton() {
            const selectedCheckboxes = document.querySelectorAll('.task-checkbox:checked');
            const count = selectedCheckboxes.length;
            const bulkBtn = document.getElementById('bulk-gold-star-btn');
            const countSpan = document.getElementById('selected-count');

            if (count > 0) {
                bulkBtn.style.display = 'block';
                countSpan.textContent = count;
            } else {
                bulkBtn.style.display = 'none';
            }
        }

        // Select and display a task
        async function selectTask(index) {
            if (index < 0 || index >= tasks.length) return;
            
            currentTaskIndex = index;
            currentTask = tasks[index];
            
            // Highlight selected task
            document.querySelectorAll('.task-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            // Load schema if not already loaded
            if (!currentSchema) {
                currentSchema = await API.getSchema(currentConquestType);
            }
            
            // Render task
            renderTask(currentTask, currentSchema);

            // Update gold-star button state
            updateGoldStarButton(currentTask.meta?.gold_star === true);

            // Show task viewer
            document.getElementById('no-task-selected').style.display = 'none';
            document.getElementById('task-viewer').style.display = 'block';
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('conquest-type-selector').addEventListener('change', onConquestTypeChange);
            document.getElementById('filter-status').addEventListener('change', () => {
                currentPage = 1;
                renderTaskList();
            });
            document.getElementById('search-box').addEventListener('input', () => {
                currentPage = 1;
                renderTaskList();
            });
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTaskList();
                }
            });
            document.getElementById('next-page').addEventListener('click', () => {
                currentPage++;
                renderTaskList();
            });
            document.getElementById('refresh-btn').addEventListener('click', refresh);
            document.getElementById('export-btn').addEventListener('click', showExportModal);
            document.getElementById('annotation-form').addEventListener('submit', submitAnnotation);
            document.getElementById('copy-llm-btn').addEventListener('click', copyLLMAnswers);
            document.getElementById('gold-star-btn').addEventListener('click', toggleGoldStar);
            document.getElementById('bulk-gold-star-btn').addEventListener('click', bulkGoldStar);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'g') {
                    e.preventDefault();
                    toggleGoldStar();
                }
            });
        }

        async function bulkGoldStar() {
            const selectedCheckboxes = document.querySelectorAll('.task-checkbox:checked');
            const taskIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.taskId));

            if (taskIds.length === 0) {
                showToast('No tasks selected', 'error');
                return;
            }

            try {
                const response = await fetch('/api/tasks/bulk-gold-star', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({task_ids: taskIds, is_gold_star: true})
                });

                if (!response.ok) throw new Error('Failed to bulk gold-star');

                const result = await response.json();

                // Update tasks in memory
                taskIds.forEach(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        task.meta = task.meta || {};
                        task.meta.gold_star = true;
                    }
                });

                // Uncheck all checkboxes
                selectedCheckboxes.forEach(cb => cb.checked = false);
                updateBulkGoldStarButton();

                // Re-render task list to show gold stars
                renderTaskList();

                showToast(`‚≠ê Marked ${result.updated_count} tasks as gold-star!`, 'success');
            } catch (error) {
                console.error('Bulk gold-star error:', error);
                showToast('Failed to bulk gold-star', 'error');
            }
        }

        async function toggleGoldStar() {
            if (!currentTask) {
                showToast('No task selected', 'error');
                return;
            }

            const isGoldStar = currentTask.meta?.gold_star === true;
            const newGoldStar = !isGoldStar;

            try {
                const response = await fetch(`/api/tasks/${currentTask.id}/gold-star`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({is_gold_star: newGoldStar})
                });

                if (!response.ok) throw new Error('Failed to update gold-star');

                // Update current task
                currentTask.meta = currentTask.meta || {};
                currentTask.meta.gold_star = newGoldStar;

                // Update button appearance
                updateGoldStarButton(newGoldStar);

                showToast(newGoldStar ? '‚≠ê Marked as gold-star!' : 'Unmarked gold-star', 'success');
            } catch (error) {
                console.error('Gold-star error:', error);
                showToast('Failed to update gold-star', 'error');
            }
        }

        function updateGoldStarButton(isGoldStar) {
            const btn = document.getElementById('gold-star-btn');
            if (isGoldStar) {
                btn.classList.add('active');
                btn.innerHTML = '‚≠ê Gold Star (Active)';
                btn.style.backgroundColor = '#fbbf24';
                btn.style.color = '#000';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '‚≠ê Gold Star';
                btn.style.backgroundColor = '';
                btn.style.color = '';
            }
        }

        async function onConquestTypeChange() {
            const selector = document.getElementById('conquest-type-selector');
            currentConquestType = selector.value;
            currentSchema = null;
            await loadTasks();
            await loadStats();
        }

        async function refresh() {
            await loadTasks();
            await loadStats();
            showToast('Refreshed', 'success');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

